<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RoSD - Ranger Sheet</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-dark: #0a0c10;
        --card-bg: #14181f;
        --accent-teal: #16e0bd;
        --accent-teal-glow: rgba(22, 224, 189, 0.3);
        --text-main: #e0d8c3;
        --input-bg: #1c2229;
        --border-col: #3a414d;
        --danger-red: #c0392b;
        --fantasy-font: 'Cinzel', serif;
        --body-font: 'Lora', serif;
    }

    body { 
        font-family: var(--body-font); 
        background: var(--bg-dark); 
        background-image: radial-gradient(circle at center, #1a1f26 0%, #0a0c10 100%);
        color: var(--text-main); 
        padding: 20px 10px; margin: 0;
    }

    h1 { 
        text-align: center; font-family: var(--fantasy-font); color: var(--accent-teal); 
        letter-spacing: 5px; text-transform: uppercase; margin: 0 0 20px 0;
        text-shadow: 0 0 15px var(--accent-teal-glow); font-size: 2.2em;
    }

    .sheet-container {
        max-width: 900px; margin: auto; background: var(--card-bg);
        border: 1px solid var(--border-col); padding: 25px; border-radius: 12px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.9);
    }

    .section-header {
        font-family: var(--fantasy-font);
        background: linear-gradient(90deg, rgba(22, 224, 189, 0.15) 0%, transparent 100%);
        color: var(--accent-teal); padding: 10px; border-left: 3px solid var(--accent-teal);
        margin-top: 25px; text-transform: uppercase; font-size: 1em;
    }

    .grid-top { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; }
    .grid-8 { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; margin-top: 15px; }

    .stat-box { 
        background: rgba(0,0,0,0.3); border: 1px solid var(--border-col); 
        text-align: center; border-radius: 6px; padding: 5px 0; 
    }
    
    .stat-label { 
        font-family: var(--fantasy-font); font-size: 0.85em; color: var(--accent-teal); 
        text-transform: uppercase; font-weight: bold; margin-bottom: 2px;
    }

    .stat-box input { 
        border: none; background: transparent; text-align: center; font-size: 1.5em; 
        font-weight: bold; height: 40px; width: 100%; color: #fff; font-family: var(--body-font);
    }
    
    .current-hp { border: 2px solid var(--danger-red); background: rgba(192, 57, 43, 0.1); }

    input, textarea, select {
        background: var(--input-bg); border: 1px solid var(--border-col); color: #fff;
        padding: 10px; width: 100%; box-sizing: border-box; border-radius: 6px;
        font-family: var(--body-font); transition: all 0.3s ease;
    }
    input:focus, select:focus { border-color: var(--accent-teal); box-shadow: 0 0 8px var(--accent-teal-glow); outline: none; }

    /* Archetype Section */
    .archetype-section { margin-top: 15px; border: 1px solid var(--border-col); border-radius: 8px; padding: 10px; background: rgba(0,0,0,0.2); }
    .archetype-btn { 
        background: transparent; color: var(--accent-teal); border: 1px solid var(--accent-teal); 
        font-family: var(--fantasy-font); font-size: 0.75em; padding: 5px 10px; margin-top: 10px; cursor: pointer;
    }
    .archetype-details { display: none; margin-top: 10px; font-size: 0.9em; border-top: 1px solid var(--border-col); padding-top: 10px; }
    .trait-list { list-style-type: none; padding-left: 0; }
    .trait-item { margin-bottom: 8px; border-left: 2px solid var(--accent-teal); padding-left: 10px; }
    .limit-item { margin-bottom: 8px; border-left: 2px solid var(--danger-red); padding-left: 10px; opacity: 0.8; }
    .type-label { font-weight: bold; font-family: var(--fantasy-font); color: var(--accent-teal); font-size: 0.8em; }

    /* Abilities & Skills */
    .numbered-row { display: flex; align-items: center; gap: 12px; margin-top: 12px; }
    .ability-toggle {
        width: 22px; height: 22px; border-radius: 50%; border: 1px solid var(--accent-teal);
        background: radial-gradient(circle, #2ecc71 0%, #16e0bd 100%); cursor: pointer;
        box-shadow: 0 0 10px var(--accent-teal-glow); transition: all 0.4s ease; flex-shrink: 0;
    }
    .ability-toggle.used { background: #2a2e35; border-color: #555; box-shadow: none; transform: scale(0.8); }
    .numbered-row.used select { text-decoration: line-through; opacity: 0.3; filter: grayscale(1); }
    .row-number { color: var(--accent-teal); font-family: var(--fantasy-font); font-weight: bold; width: 25px; text-align: center; }
    .ability-desc { font-size: 0.85em; color: #a0a0a0; font-style: italic; margin-left: 65px; margin-top: 4px; display: none; }
    .info-toggle {
        width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--accent-teal);
        background: rgba(22, 224, 189, 0.1); cursor: pointer; flex-shrink: 0;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.9em; color: var(--accent-teal); transition: all 0.3s ease;
        font-family: var(--fantasy-font); font-weight: bold;
    }
    .info-toggle:hover { background: rgba(22, 224, 189, 0.2); transform: scale(1.1); }
    .info-toggle.active { background: var(--accent-teal); color: #000; }

    .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
    .skill-row { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .skill-name { font-size: 0.95em; color: #cbd5e0; }
    .skill-input { width: 60px !important; text-align: center; font-weight: bold; color: var(--accent-teal); font-size: 1.1em; padding: 5px; }

    .notes-area { height: 180px; margin-top: 15px; background: rgba(0,0,0,0.2); font-style: italic; }

    .footer-btns { margin-top: 40px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
    button { 
        background: transparent; color: var(--accent-teal); border: 1px solid var(--accent-teal);
        padding: 12px 24px; border-radius: 6px; cursor: pointer; font-family: var(--fantasy-font);
        font-weight: bold; transition: all 0.3s;
    }
    button:hover { background: var(--accent-teal); color: #000; }

    @media (max-width: 768px) {
        .main-grid { grid-template-columns: 1fr; }
        .grid-8 { grid-template-columns: repeat(4, 1fr); }
        .grid-top { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>

    <h1>Ranger Sheet</h1>

    <div class="sheet-container">
        <div class="grid-top">
            <div class="stat-box"><div class="stat-label">Ranger Name</div><input type="text" id="char_name" class="save-field" placeholder="z.B. Verus"></div>
            <div class="stat-box"><div class="stat-label">Level</div><input type="number" id="char_lvl" class="save-field"></div>
            <div class="stat-box"><div class="stat-label">Experience</div><input type="number" id="char_xp" class="save-field"></div>
        </div>

        <div class="archetype-section">
            <label class="stat-label">Archetype</label>
            <select id="char_arch" class="save-field" onchange="updateArchetype()">
                </select>
            <div id="arch_toggle_container" style="display:none;">
                <button class="archetype-btn" id="arch_btn" onclick="toggleArchDetails()">Show Archetype Details</button>
                <div id="arch_details" class="archetype-details"></div>
            </div>
        </div>

        <div class="grid-8">
            <div class="stat-box"><div class="stat-label">Mov</div><input type="number" id="s_mov" class="save-field"></div>
            <div class="stat-box"><div class="stat-label">Fig</div><input type="number" id="s_fig" class="save-field"></div>
            <div class="stat-box"><div class="stat-label">Sho</div><input type="number" id="s_sho" class="save-field"></div>
            <div class="stat-box"><div class="stat-label">Arm</div><input type="number" id="s_arm" class="save-field"></div>
            <div class="stat-box"><div class="stat-label">Wil</div><input type="number" id="s_wil" class="save-field"></div>
            <div class="stat-box"><div class="stat-label">Health</div><input type="number" id="s_hpm" class="save-field"></div>
            <div class="stat-box current-hp"><div class="stat-label">Current</div><input type="number" id="s_hpc" class="save-field"></div>
            <div class="stat-box"><div class="stat-label">Recr</div><input type="number" id="s_rec" class="save-field"></div>
        </div>

        <div class="main-grid">
            <div>
                <div class="section-header">Heroic Abilities & Spells</div>
                <div id="abilities-list">
                    <div class="ability-group">
                        <div class="numbered-row" id="row_ab1"><div class="ability-toggle" onclick="toggleUse('ab1')"></div><span class="row-number">I</span><select id="ab1" class="save-field ab-select" onchange="updateDesc('ab1')"></select><div class="info-toggle" onclick="toggleDescVisibility('ab1')">â„¹</div></div>
                        <div id="desc_ab1" class="ability-desc"></div>
                    </div>
                    <div class="ability-group">
                        <div class="numbered-row" id="row_ab2"><div class="ability-toggle" onclick="toggleUse('ab2')"></div><span class="row-number">II</span><select id="ab2" class="save-field ab-select" onchange="updateDesc('ab2')"></select><div class="info-toggle" onclick="toggleDescVisibility('ab2')">â„¹</div></div>
                        <div id="desc_ab2" class="ability-desc"></div>
                    </div>
                    <div class="ability-group">
                        <div class="numbered-row" id="row_ab3"><div class="ability-toggle" onclick="toggleUse('ab3')"></div><span class="row-number">III</span><select id="ab3" class="save-field ab-select" onchange="updateDesc('ab3')"></select><div class="info-toggle" onclick="toggleDescVisibility('ab3')">â„¹</div></div>
                        <div id="desc_ab3" class="ability-desc"></div>
                    </div>
                    <div class="ability-group">
                        <div class="numbered-row" id="row_ab4"><div class="ability-toggle" onclick="toggleUse('ab4')"></div><span class="row-number">IV</span><select id="ab4" class="save-field ab-select" onchange="updateDesc('ab4')"></select><div class="info-toggle" onclick="toggleDescVisibility('ab4')">â„¹</div></div>
                        <div id="desc_ab4" class="ability-desc"></div>
                    </div>
                    <div class="ability-group">
                        <div class="numbered-row" id="row_ab5"><div class="ability-toggle" onclick="toggleUse('ab5')"></div><span class="row-number">V</span><select id="ab5" class="save-field ab-select" onchange="updateDesc('ab5')"></select><div class="info-toggle" onclick="toggleDescVisibility('ab5')">â„¹</div></div>
                        <div id="desc_ab5" class="ability-desc"></div>
                    </div>
                </div>

                <div class="section-header">Equipment</div>
                <div class="numbered-row"><span style="color:var(--accent-teal); width:20px; font-family:var(--fantasy-font);">1</span><input type="text" id="it1" class="save-field"></div>
                <div class="numbered-row"><span style="color:var(--accent-teal); width:20px; font-family:var(--fantasy-font);">2</span><input type="text" id="it2" class="save-field"></div>
                <div class="numbered-row"><span style="color:var(--accent-teal); width:20px; font-family:var(--fantasy-font);">3</span><input type="text" id="it3" class="save-field"></div>
                <div class="numbered-row"><span style="color:var(--accent-teal); width:20px; font-family:var(--fantasy-font);">4</span><input type="text" id="it4" class="save-field"></div>
                <div class="numbered-row"><span style="color:var(--accent-teal); width:20px; font-family:var(--fantasy-font);">5</span><input type="text" id="it5" class="save-field"></div>
                <div class="numbered-row"><span style="color:var(--accent-teal); width:20px; font-family:var(--fantasy-font);">6</span><input type="text" id="it6" class="save-field"></div>
            </div>

            <div>
                <div class="section-header">Skills</div>
                <div class="skill-row"><span class="skill-name">Acrobatics</span><input type="number" id="sk_ac" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Ancient Lore</span><input type="number" id="sk_al" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Armoury</span><input type="number" id="sk_ar" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Climb</span><input type="number" id="sk_cl" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Leadership</span><input type="number" id="sk_le" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Navigation</span><input type="number" id="sk_na" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Perception</span><input type="number" id="sk_pe" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Pick Lock</span><input type="number" id="sk_pl" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Read Runes</span><input type="number" id="sk_rr" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Stealth</span><input type="number" id="sk_st" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Strength</span><input type="number" id="sk_sr" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Survival</span><input type="number" id="sk_sv" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Swim</span><input type="number" id="sk_sw" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Track</span><input type="number" id="sk_tr" class="save-field skill-input"></div>
                <div class="skill-row"><span class="skill-name">Traps</span><input type="number" id="sk_tp" class="save-field skill-input"></div>
            </div>
        </div>

        <div class="section-header">Quest Chronicles</div>
        <textarea id="quest_notes" class="save-field notes-area" placeholder="Schreibe deine Legende..."></textarea>

        <div class="footer-btns">
            <button onclick="downloadJSON()">ðŸ’¾ Save Character File</button>
            <label for="import-file" style="cursor:pointer; border:1px solid var(--accent-teal); padding:12px 24px; border-radius:6px; font-family:var(--fantasy-font); font-weight:bold; font-size:0.85em; color:var(--accent-teal);">ðŸ“‚ Load Character File</label>
            <input type="file" id="import-file" style="display:none" onchange="importJSONFile(event)">
            <button onclick="clearSheet()" style="border-color: #555; color: #777;">ðŸ’€ Obliterate</button>
        </div>
    </div>

<script>
    // --- LIBRARIES ---
    const ABILITY_LIBRARY = {
        heroic: {
            "Blend into the Shadows": "This ability may be used if an evil figure is about to make a move that would take it into combat with the ranger. Instead, determine the evil figure's action as though the ranger were not on the table.",
            "Call to Action": "This ability may be used whenever the ranger activates. The ranger may activate one more companion in the Ranger phase than is normally allowed. (So, if the ranger can normally activate 0 companions in the Ranger Phase, he may activate 1 instead).",
            "Dash": "The ranger may use this ability when he is activated. For the rest of the turn, he receives +2 Move. Alternatively, the ranger may use a move action to leap up to his Move distance in any direction, including vertically.",
            "Deadly Shot": "The ranger may use this ability if he has rolled a natural 18 or 19 during a shooting action. Treat this roll as a Critical Hit.",
            "Deadly Strike": "The ranger may use this ability if he has rolled a natural 18 or 19 during a fight. Treat this roll as a Critical Hit.",
            "Distraction": "The ranger may use this ability whenever an evil creature is called upon to make either a random move or a move towards the Target Point. The player may instead move this creature anywhere he wishes following the standard rules for movement, provided this move does not cause the creature direct harm or force it to make Swimming Rolls.",
            "Dive for Cover": "The ranger may add +10 to his Fight Roll when rolling against a shooting attack. He must declare he is using this ability before he rolls.",
            "Eldritch Recall": "This ability can be used at any time. The figure regains the use of any one spell that it has already cast during the scenario.",
            "Enhanced Power": "This ability may be used any time a figure casts a spell that generates a shooting attack. For each shooting attack generated, the figure may roll three dice for the shooting attack and pick the best one. The player must decide to use this ability before any dice are rolled.",
            "Evade": "The ranger may use this ability if he activates while in combat. The ranger may make a free 1\" move to leave the combat. No figure may force combat during this move. After this move, the ranger completes his activation as normal.",
            "Focus": "The ranger may add +8 to any one Skill Roll. He must declare he is using this ability before he rolls.",
            "Frenzied Attack": "The ranger may add +5 to one Fight Roll. He must declare he is using this ability before he rolls.",
            "Halt Undead": "All undead creatures within 10\" and line of sight of the ranger must make a Will Roll (TN20). If they fail, they lose their next activation.",
            "Hand of Fate": "The ranger may re-roll one die.",
            "Inner Strength": "The ranger may add +5 to one Will Roll. This ability can be used after the roll has been made.",
            "Parry": "This ability may be used in combat after a ranger and his opponent have made their Fight Rolls. The ranger may add +10 to his roll. If he wins the combat, however, he does no damage. He may step back or push his opponent back as normal.",
            "Powerful Blow": "The hero may add +3 damage to any hand-to-hand attack that has already dealt at least 1 point of damage.",
            "Quick Cast": "A figure that activates and has two or more actions may use this ability. During this activation it may use two actions to cast Spells. This overrides the normal rules that only one Spell may be cast during a figure's activation, and that one action must be movement.",
            "Roll with the Punch": "This ability may be used if a ranger loses a fight in hand-to-hand combat. Halve the amount of damage taken by the ranger, rounding up (e.g. if the ranger loses the combat and would suffer 7 points of damage, he suffers 4 instead).",
            "Shove": "If the ranger wins in hand-to-hand combat, he may choose to push his opponent back up to 4\" instead of the normal 1\".",
            "Split Cast": "This ability may be used any time a figure casts a spell that has a specific target figure or target point. The caster may choose two different targets for the Spell, resolving the full effect of the Spell on both targets.",
            "Steady Aim": "The hero may add +5 Shoot for one Shooting Roll. This must be declared before the roll is made."
        },
        spells: {
            "Amphibious": "The target of this spell automatically passes all Swimming Rolls for the rest of the scenario.",
            "Armour": "The target of this spell receives +2 Armour for the rest of the scenario. A figure can only receive the benefits of one Armour spell at one time.",
            "Awareness": "The caster may immediately cast this spell anytime he is called upon to make a Perception Skill Roll. It can be used either before or after a scenario. The caster automatically passes the Perception Roll.",
            "Burning Light": "Make a +3 attack against all undead creatures within 8\" and line of sight of the caster.",
            "Burning Mark": "The caster may place a glowing rune anywhere within 6\". As soon as any evil creature moves within 2\" of this rune, it explodes. All evil creatures within 2\" of the rune suffer a +5 magic shooting attack.",
            "Caltrops": "Creates a 2\" diameter circle of caltrops. Any figure moving through this circle suffers 2 points of damage and must make a Will Roll (TN12). If it fails, its activation ends immediately. Undead creatures are immune to this damage.",
            "Compass": "The caster may immediately cast this spell anytime he is called upon to make a Navigation Skill Roll. It can be used either before or after a scenario. The caster automatically passes the Navigation Roll.",
            "Enchanted Steel": "The caster imbues one melee weapon with magic power. For the rest of the scenario, the weapon counts as a magic weapon with +1 Fight.",
            "Fireball": "Pick a point within line of sight. All figures within 2\" of that point suffer a +3 shooting attack.",
            "Glow": "For the rest of the game, all shooting attacks against the target of this spell are at +3.",
            "Heal": "This spell may target any figure within 6\" including the caster. The target figure regains up to 5 points of lost Health.",
            "Hold Creature": "The target creature must make an immediate Will Roll (TN16). If it fails, it may not force combat for the remainder of the turn, and it loses its next activation. This spell has no effect on large creatures or undead.",
            "Insect Climb": "The target of the spell does not suffer any movement penalty when climbing. The figure receives +10 to all Climb Skill Rolls for the rest of the game.",
            "Ladder": "The caster may place a magical ladder against any vertical or nearly vertical surface. Any figure may climb this ladder without any movement penalty or Climb Skill Rolls. As long as there is no figure on the ladder, the caster can end the spell at any time as a free action.",
            "Leap": "This spell may only be cast on a ranger or companion not currently in combat. That figure may immediately make a 6\" move in any direction, including up.",
            "Light": "If the maximum line of sight for a scenario is below 24\" because of darkness, this spell increases it back up to 24\".",
            "Lure": "The target of this spell must make an immediate Will Roll (TN16). If it fails, the caster may move the figure up to 5\" in any direction. This may not move the figure off the table or into anything that would cause it damage. Cannot be cast on a creature currently in combat.",
            "Magic Bolt": "The caster makes a +5 magic shooting attack against one figure within line of sight. This attack ignores penalties for cover and intervening terrain.",
            "Open": "The caster may immediately cast this spell anytime he is called upon to make a Pick Lock Skill Roll. It can be used either before or after a scenario. The caster automatically passes the Pick Lock Roll.",
            "Quickness": "The target of this spell will activate in the Ranger Phase next turn. In addition, the target receives +1 Move for the rest of the scenario.",
            "Shield of Light": "This spell may be cast on any figure within 8\" and line of sight. All shooting attacks against this figure are at -3 for the rest of the game.",
            "Slow": "The target of this spell must make an immediate Will Roll (TN18). If it fails, it suffers -3 Move (to a minimum of 1) for the rest of the scenario.",
            "Smoke": "The caster may place a thick cloud of smoke, 3\" in diameter, anywhere within 3\". The smoke blocks all line of sight but does not inhibit movement.",
            "Strength": "The target of this spell does +1 damage in hand-to-hand combat for the rest of the scenario. In addition, it receives +5 to any Strength Skill Rolls it makes.",
            "Strong Heart": "This spell may be cast against any figure within 8\" and line of sight. The next time this figure must make a Will Roll it does so with a +5 modifier. The time after that, it receives +4, and so on, down to +0 when the spell's effect ends.",
            "Summon Crow": "The caster summons a crow to his aid. At the end of the turn, place a bird in contact with the caster. This bird has the same stats as a raptor, except it only has Armour 10 and no skills. Treat this bird as a companion. At the end of the bird's activation each turn, roll a die. On a 16+ the bird flies off and is removed from the table.",
            "Swat": "Make a +8 attack against one giant fly or giant spider in line of sight.",
            "Teleport": "The caster may immediately move up to 9\" in any direction, including up. This may not take the figure off the table. The figure may take no actions for the rest of the turn after casting this spell.",
            "Translate": "The caster may immediately cast this spell anytime he is called upon to make a Read Runes Skill Roll. It can be used either before or after a scenario. The caster automatically passes the Read Runes Roll.",
            "Transpose": "Immediately switch the places of any two rangers or companions on the table. Either or both of these figures may be in combat.",
            "Weakness": "The target of this spell must make an immediate Will Roll (TN18). If it fails, it suffers -1 Fight, -1 Shoot, and -1 Armour for the rest of the scenario."
        }
    };

    const ARCHETYPE_LIBRARY = {
        "": { traits: [], limits: [] },
        "Red Hawk Knight": {
            traits: [
                "Heavy Armour Proficient â€“ Red Hawk Knights are highly trained in wearing heavy armour and do not suffer the -1 Move penalty for wearing it.",
                "Deflect Arrows â€“ If a Red Hawk Knight is armed with a shield, it receives +4 Fight when making Combat Rolls against shooting attacks.",
                "Save the Children â€“ Red Hawk Knights gain a special bonus of +15 experience points for any scenario in which a child is saved or rescued."
            ],
            limits: [
                "Cannot Be a Spellcaster â€“ Red Hawk Knights have no training in magic and can thus never use spells, scrolls, or spellbooks.",
                "No Missile Weapons â€“ Red Hawk Knights are forbidden by their order from using any missile weapons (anything that generates a shooting attack) as these are seen as too random, and too likely to harm innocent bystanders.",
                "Protect the Children â€“ Red Hawk Knights may not voluntarily leave a table if there is a child under threat upon it."
            ]
        },
        "Chthonian Mage": {
            traits: [
                "Dark Vision â€“ Chthonian Mages can see in the dark just as well as they can in the light. They never suffer any penalties of any kind (usually line of sight or shooting) because of low-light or darkness.",
                "Innate Spells â€“ A Chthonian Mage can always convert any of its spells to one of the following spells at any point: Compass, Dark Vision, Hold Creature, Purify Blood, Sprout Mushrooms.",
                "Plant Warden â€“ Chthonian Mages receive +3 Fight and +3 Armour when fighting plants, such as darkroot vines."
            ],
            limits: [
                "No Spellbooks or Wands â€“ Because Chthonian Mages use an animistic form of spellcasting, they may not use either spellbooks or wands.",
                "Spell Limitations â€“ While Chthonian Mages have access to all the spells in the main rulebook, some of the more offensive spells they can only take once (as opposed to rangers who may take a given spell any number of times).",
                "Weapon and Armour Limitations â€“ Chthonian Mages cannot wear heavy armour as it interferes with their spellcasting. While not forbidden, Chthonian Mages never train to use bows, crossbows, or two-handed weapons and receive -2 Fight/Shoot when using them. Hand weapons, staffs, daggers and throwing knives suffer no penalty."
            ]
        },
        "River Shark": {
            traits: [
                "Boatmen â€“ River Sharks gain +3 to all rolls for the purpose of handling a boat.",
                "Swimming Master â€“ If a River Shark fails a Swimming Roll, it suffers only half the normal damage, rounded down, and may still make one move of up to 3\" before its activation ends, provided it is not in combat. This trait does not apply if the figure is wearing armour of any type.",
                "Throwing Knife Master â€“ River Sharks can carry two throwing knives with one item slot. When using a throwing knife, they do not suffer the usual -1 damage penalty. A River Shark may target an enemy figure that is in combat when making a shooting attack with a throwing knife and has no chance of hitting any target but the intended one.",
                "Treasure Keeper â€“ If players find 'Gold and Jewels' during a game, and one of them is running a River Shark, the gold and jewels can be traded in for +15 experience or 2 Progression Points split between two companions. Any treasures that state they must be given back at the end of a mission must still be returned by River Sharks.",
                "Two-Weapon Fighter â€“ If a River Shark is equipped with two hand weapons, or a hand weapon and a dagger, and is not carrying a shield, then it does +2 damage in melee combat, and any figure it is in combat with only gains +1 for each supporting figure (instead of the normal +2)."
            ],
            limits: [
                "No Heavy Equipment â€“ River Sharks never wear heavy armour or use two-handed weapons.",
                "No Spells â€“ River Sharks have no spellcasters in their ranks and cannot take spells."
            ]
        },
        "Servant of Seth": {
            traits: [
                "End of Life â€“ If a Servant of Seth has a companion killed (a Dead result is rolled on the Survival Table), then the servant can perform the last rites and ensure that the companion never reanimates as an undead creature. All players gain +3 experience points.",
                "Holy Icon â€“ Servants of Seth always carry a Holy Icon, which does not take up one of their item slots, though it does count as the one piece of magical equipment that they can take as standard (all other magical equipment must be obtained during adventures).",
                "Innate Heroic Action â€“ Servants of Seth focus on defeating the undead. Thus, they can always trade any Heroic Action they currently have for Halt Undead. They can make this trade at any time and may even use it more than once during a scenario.",
                "Innate Spells â€“ A servant can always convert any of its spells to one of the following spells at any point: Burning Light, Shield of Light, and Magic Bolt (though this can only be cast against an undead creature).",
                "Taref â€“ Servants of Seth have access to a special throwing weapon called a taref. A servant may carry as many of these as it has item slots available. It may carry one taref in place of the free item slot usually reserved for a dagger or throwing knife.",
                "Undead Fighter â€“ When a Servant of Seth is in combat with an undead creature of any variety, all the servant's melee attacks do +1 damage and count as magic attacks."
            ],
            limits: [
                "No Wands â€“ Servants of Seth never use wands in spellcasting.",
                "Spell Limitations â€“ There are a few spells that Servants of Seth cannot cast. These are detailed below.",
                "Weapon Limitations â€“ Servants of Seth cannot use bladed or piercing weapons. Functionally, this means that they cannot use bows, crossbows, or throwing knives. Instead of the free dagger or knife that most figures can carry, the servant may carry a taref. Servants also cannot use any specific magic weapons that state they are bladed or piercing such as swords, axes, picks, spears, etc."
            ]
        },
        "Varakian Archer": {
            traits: [
                "Craft Bow â€“ After any scenario, if a Varakian Archer does not have a bow and has no way of obtaining one, it may craft a temporary bow out of whatever material is available. This bow does -1 damage, but otherwise functions the same as a normal bow.",
                "Enchant Arrow â€“ A Varakian Archer may spend an action to enchant an arrow. This can take the place of its normally required move action. The next time the archer fires its bow, the shot counts as Magic and does +1 damage.",
                "Enhanced Quiver â€“ A Varakian Archer that is carrying a Quiver may carry up to 3 magical arrows in the quiver without them taking up an item slot (instead of the usual 1)."
            ],
            limits: [
                "No Heavy Armour or Shields â€“ Varakian Archers may not wear heavy armour or carry shields as they interfere with their aim.",
                "No Spells â€“ Varakian Archers cannot learn or cast spells, other than their magical tricks with arrows, and never count as a spellcaster."
            ]
        },
        "Vampire Hunter": {
            traits: [
                "Blood Price â€“ Whenever a vampire hunter activates, it may choose to suffer 1 point of damage. If it does, all its attacks against undead count as magic attacks and do +1 damage until its next activation.",
                "Chosen Foe â€“ If the vampire hunter participates in a scenario in which a vampire is killed, then all heroes gain +5 experience points in addition to any other rewards. If the vampire hunter directly kills a vampire, increase this to +10 experience points.",
                "Hand Crossbow â€“ Vampire hunters have access to the unique hand crossbow weapon.",
                "Steel Mind â€“ Vampire hunters receive +3 to any Will Rolls to resist any kind of hypnosis or mind control."
            ],
            limits: [
                "Limited Magical Equipment â€“ Vampire hunter spellcasters cannot use focusing crystals, wands, or wizard staffs.",
                "Limited Spells â€“ Vampire hunters may never take a spell more than once."
            ]
        },
        "Scrollmaster of Melnoth": {
            traits: [
                "Magic Resistance â€“ Scrollmasters are practised in resisting magic spells. They gain +3 to all Will Rolls to resist spells. If they are the target of an attack generated by a spell, they gain +3 Fight on any Combat Rolls to not be hit, and +3 Armour if they are hit.",
                "Scrollmaster â€“ Scrollmasters may carry up to three scrolls in one item slot. Additionally, they may copy a spell from a scroll into their spellbook if no other spell is currently saved in the spellbook. In this case the scroll is destroyed.",
                "Seekers of Knowledge â€“ Scrollmasters gain +1 experience point in any scenario in which any kind of book or scroll is found by the group (the work does not have to be magical).",
                "Spellbook Caster â€“ Scrollmasters are trained in casting magic spells directly from spellbooks. This figure may purchase one open spell slot for the cost of 1 Build Point. So long as this figure is carrying a spellbook, it may use this open spell slot to cast any spell found in the main rulebook. Additionally, this figure may carry a spellbook without it taking up an item slot."
            ],
            limits: [
                "Armour Limitation â€“ Scrollmasters may not wear heavy or light armour or carry shields as they interfere with their spellcasting.",
                "Weapon Limitations â€“ Scrollmasters are not trained fighters. They may never use two-handed weapons, bows, or crossbows."
            ]
        },
        "Encarnoth Delver": {
            traits: [
                "Determine Weakness â€“ Due to their vast knowledge of ancient myths and legends, delvers often know the weaknesses of various creatures. If this figure is within line of sight of a creature, it may spend an action and make an Ancient Lore Roll with a Target Number equal to 10 plus the creature's Will Stat. If successful, all heroes fighting against this type of creature gain +1 Fight for the rest of the scenario.",
                "Endure Hardship â€“ Encarnoth Delvers are used to a life of hardship. If this figure is suffering from Hunger and Thirst, it only suffers a -1 penalty to its starting Health each scenario instead of the normal -2. It also gains +5 to all rolls against Disease.",
                "Pack Rat â€“ Encarnoth Delvers have one extra item slot, as they are masters of packing carefully to maximize space and save weight.",
                "Skillmaster (Choice) â€“ This figure gains +3 to any one skill, selected by the player."
            ],
            limits: [
                "Limited Weapons and Armour â€“ Delvers cannot wear heavy armour, carry shields, or use two-handed weapons."
            ]
        },
        "Wasteland Firesword": {
            traits: [
                "Endure Hardship â€“ Wastelanders are used to a life of hardship. If this figure is suffering from Hunger and Thirst, it only suffers a -1 penalty to its starting Health each scenario instead of the normal -2. It also gains +5 to all rolls against Disease.",
                "Exotic Weapons â€“ Fireswords can take fire wax and fire flasks as part of the Basic Equipment List.",
                "Two-Weapon Fighter â€“ If the firesword is equipped with two hand weapons, or a hand weapon and a dagger, then it does +2 damage in melee combat, and any figure it is in combat with only gains +1 for each supporting figure (instead of the normal +2)."
            ],
            limits: [
                "Cannot Be Spellcasters â€“ Fireswords may never be spellcasters and thus never take spells or use scrolls or spellbooks.",
                "Cannot Swim â€“ There is no deep water in the Waste, so no wastelander knows how to swim. This figure suffers -3 to all Swimming Rolls. Additionally, its Swim Skill may never be increased until this limitation is removed.",
                "Limited Weapons and Armour â€“ Wastelanders never wear heavy armour or carry shields as they are extremely impractical in the heat of the Waste. Wastelanders also never use crossbows as these weapons are not part of their culture."
            ]
        }
    };

    const saveFields = document.querySelectorAll('.save-field');
    const STORAGE_KEY = 'rosd_ranger_v_archetypes';

    function populateDropdowns() {
        const selects = document.querySelectorAll('.ab-select');
        selects.forEach(sel => {
            const emptyOpt = document.createElement('option');
            emptyOpt.value = ""; emptyOpt.innerHTML = "Choose an Ability or Spell...";
            sel.appendChild(emptyOpt);

            const heroicGroup = document.createElement('optgroup');
            heroicGroup.label = 'Heroic Abilities';
            for (let key in ABILITY_LIBRARY.heroic) {
                let o = document.createElement('option');
                o.value = key; o.innerHTML = key;
                heroicGroup.appendChild(o);
            }
            sel.appendChild(heroicGroup);

            const spellGroup = document.createElement('optgroup');
            spellGroup.label = 'Spells';
            for (let key in ABILITY_LIBRARY.spells) {
                let o = document.createElement('option');
                o.value = key; o.innerHTML = key;
                spellGroup.appendChild(o);
            }
            sel.appendChild(spellGroup);
        });

        const archSel = document.getElementById('char_arch');
        for (let key in ARCHETYPE_LIBRARY) {
            let opt = document.createElement('option');
            opt.value = key; opt.innerHTML = key === "" ? "None / Custom" : key;
            archSel.appendChild(opt);
        }
    }

    function updateArchetype() {
        const val = document.getElementById('char_arch').value;
        const detailsDiv = document.getElementById('arch_details');
        const container = document.getElementById('arch_toggle_container');
        
        if (val && val !== "") {
            container.style.display = "block";
            let html = '<div class="type-label">Traits:</div><ul class="trait-list">';
            ARCHETYPE_LIBRARY[val].traits.forEach(t => html += `<li class="trait-item">${t}</li>`);
            html += '</ul><div class="type-label" style="color:var(--danger-red)">Limitations:</div><ul class="trait-list">';
            ARCHETYPE_LIBRARY[val].limits.forEach(l => html += `<li class="limit-item">${l}</li>`);
            html += '</ul>';
            detailsDiv.innerHTML = html;
        } else {
            container.style.display = "none";
        }
        save();
    }

    function toggleArchDetails() {
        const div = document.getElementById('arch_details');
        const btn = document.getElementById('arch_btn');
        if (div.style.display === "block") {
            div.style.display = "none";
            btn.innerHTML = "Show Archetype Details";
        } else {
            div.style.display = "block";
            btn.innerHTML = "Hide Archetype Details";
        }
    }

    function updateDesc(id) {
        const val = document.getElementById(id).value;
        const desc = val ? (ABILITY_LIBRARY.heroic[val] || ABILITY_LIBRARY.spells[val] || "") : "";
        document.getElementById('desc_' + id).innerHTML = desc;
        save();
    }

    function toggleUse(id) {
        document.getElementById('row_' + id).classList.toggle('used');
        save();
    }

    function toggleDescVisibility(id) {
        const descDiv = document.getElementById('desc_' + id);
        const infoBtn = event.target;

        if (descDiv.style.display === "block") {
            descDiv.style.display = "none";
            infoBtn.classList.remove('active');
        } else {
            descDiv.style.display = "block";
            infoBtn.classList.add('active');
        }
    }

    function save() {
        const data = {};
        saveFields.forEach(f => data[f.id] = f.value);
        for(let i=1; i<=5; i++) data['ab' + i + '_used'] = document.getElementById('row_ab' + i).classList.contains('used');
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function applyData(data) {
        saveFields.forEach(f => { 
            if(data[f.id] !== undefined) f.value = data[f.id]; 
            if(f.classList.contains('ab-select')) updateDesc(f.id);
            if(f.id === 'char_arch') updateArchetype();
        });
        for(let i=1; i<=5; i++) {
            const row = document.getElementById('row_ab' + i);
            if(data['ab' + i + '_used']) row.classList.add('used');
            else row.classList.remove('used');
        }
        save();
    }

    function load() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw) applyData(JSON.parse(raw));
    }

    saveFields.forEach(f => f.addEventListener('input', save));
    window.onload = () => { populateDropdowns(); load(); };

    function downloadJSON() {
        const data = localStorage.getItem(STORAGE_KEY);
        const name = document.getElementById('char_name').value || 'Ranger';
        const now = new Date();
        const dateStr = `${now.getDate().toString().padStart(2, '0')}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        const timeStr = `${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `RoSD_${name}_${dateStr}_${timeStr}.json`; a.click();
    }

    function importJSONFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => { try { applyData(JSON.parse(e.target.result)); } catch (err) { alert("Invalid File!"); } };
        reader.readAsText(file);
    }

    function clearSheet() { if(confirm("Obliterate this Ranger?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>